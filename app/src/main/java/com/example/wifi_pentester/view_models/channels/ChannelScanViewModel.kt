package com.example.wifi_pentester.view_models.channels

import android.app.Application
import androidx.lifecycle.AndroidViewModel
import androidx.lifecycle.viewModelScope
import com.example.wfc_data.database.channles.ChannelEntity
import com.example.wfc_data.database.channles.repositories.IChannelsRepository
import com.example.wfc_models.channels.dtos.WifiChannel
import com.example.wfc_models.settings.ISettingsService
import com.example.wfc_models.settings.dtos.WifiFilter
import com.example.wfc_models.settings.dtos.WifiScannerSetting
import com.example.wfc_models.wifi.converters.WifiConverter.Companion.convertFrequencyToFrequencyType
import com.example.wfc_models.wifi.scanners.contracts.IWifiScanService
import com.example.wfc_models.wifi.scanners.dtos.FrequencyType
import com.example.wfc_models.wifi.scanners.dtos.Wifi
import dagger.hilt.android.lifecycle.HiltViewModel
import kotlinx.coroutines.flow.MutableStateFlow
import kotlinx.coroutines.flow.map
import kotlinx.coroutines.launch
import javax.inject.Inject

@HiltViewModel
class ChannelScanViewModel @Inject constructor(
    application: Application,
    private val _channelsRepository: IChannelsRepository,
    private val _wifiScanService: IWifiScanService,
    private val _settingService: ISettingsService,
) : AndroidViewModel(application) {
    private val channelsByFrequencyType = mutableMapOf<FrequencyType, List<ChannelEntity>>()

    val is5GzMode = MutableStateFlow(false)

    val channels = _wifiScanService.wifiList.map { wifis ->
        val wifisByChannels = wifis
            .groupBy { it.channel }
            .toMap()

        val channels =
            if (is5GzMode.value) channelsByFrequencyType[FrequencyType.F5]
            else channelsByFrequencyType[FrequencyType.F24]

        val result = channels!!.map { channel ->
            val wifi = wifisByChannels[channel.value]
            val wifiCount = wifi?.size ?: 0

            return@map WifiChannel(channel.value, wifiCount)
        }

        return@map result
    }

    init {
        viewModelScope.launch {
            val allChannels = _channelsRepository.getAllByFrequencyAsync().values
                .groupBy { convertFrequencyToFrequencyType(it.frequency) }
                .toMap()

            channelsByFrequencyType.putAll(allChannels)
        }
    }

    fun startScan() {
        viewModelScope.launch {
            val frequencyFilters = setOf(
                WifiFilter(Wifi::frequencyType.name, FrequencyType.F24.toString()),
                WifiFilter(Wifi::frequencyType.name, FrequencyType.F5.toString()),
                WifiFilter(Wifi::frequencyType.name, FrequencyType.F6.toString())
            )

            val wifiScannerSettings = _settingService.getSetting(WifiScannerSetting::class.java)!!

            wifiScannerSettings.filters = wifiScannerSettings.filters
                .filter { !frequencyFilters.contains(it) }

            _wifiScanService.startScan(wifiScannerSettings)
        }
    }

    fun stopScan() {
        viewModelScope.launch {
            _wifiScanService.stopScan()
        }
    }
}