package com.example.wifi_pentester.view_models.settings

import androidx.lifecycle.ViewModel
import com.example.wfc_models.settings.IInitSettingsService
import com.example.wfc_models.settings.ISettingsService
import com.example.wfc_models.settings.data_models.WifiFilter
import com.example.wfc_models.settings.data_models.WifiScannerSettings
import com.example.wfc_models.settings.data_models.WifiSortMode
import com.example.wfc_models.wifi.scanners.data_models.EncryptionType
import com.example.wfc_models.wifi.scanners.data_models.FrequencyType
import com.example.wfc_models.wifi.scanners.data_models.Wifi
import dagger.hilt.android.lifecycle.HiltViewModel
import kotlinx.coroutines.coroutineScope
import kotlinx.coroutines.flow.MutableStateFlow
import javax.inject.Inject

@HiltViewModel
class WifiScannerSettingsViewModel @Inject constructor(
    private val _settingService: ISettingsService,
    private val _initSettingsService: IInitSettingsService
) : ViewModel() {
    val isChannelSortMode = MutableStateFlow(false)
    val isProviderNameSortMode = MutableStateFlow(false)
    val isSignalLevelSortMode = MutableStateFlow(false)
    val isNameSortMode = MutableStateFlow(false)

    val isOpenFilter = MutableStateFlow(false)
    val isWepFilter = MutableStateFlow(false)
    val isWpaFilter = MutableStateFlow(false)
    val isWpa2Filter = MutableStateFlow(false)
    val isWpa3Filter = MutableStateFlow(false)
    val isWpsFilter = MutableStateFlow(false)
    val isFrequency24Filter = MutableStateFlow(false)
    val isFrequency5Filter = MutableStateFlow(false)

    private val mutableStatePropertiesByWifiFilter = mapOf(
        WifiFilter(Wifi::encryptionType.name, EncryptionType.OPEN.toString()) to isOpenFilter,
        WifiFilter(Wifi::encryptionType.name, EncryptionType.WEP.toString()) to isWepFilter,
        WifiFilter(Wifi::encryptionType.name, EncryptionType.WPA.toString()) to isWpaFilter,
        WifiFilter(Wifi::encryptionType.name, EncryptionType.WPA2.toString()) to isWpa2Filter,
        WifiFilter(Wifi::encryptionType.name, EncryptionType.WPA3.toString()) to isWpa3Filter,
        WifiFilter(Wifi::haveWps.name, true.toString()) to isWpsFilter,
        WifiFilter(Wifi::frequencyType.name, FrequencyType.F24.toString()) to isFrequency24Filter,
        WifiFilter(Wifi::frequencyType.name, FrequencyType.F5.toString()) to isFrequency5Filter,
    )

    private val mutableStatePropertiesBySortMode = mapOf(
        WifiSortMode.CHANNEL to isChannelSortMode,
        WifiSortMode.PROVIDER_NAME to isProviderNameSortMode,
        WifiSortMode.SIGNAL_LEVEL to isSignalLevelSortMode,
        WifiSortMode.NAME to isNameSortMode,
    )

    suspend fun synchronizeStateBySettings(wifiScannerSettings: WifiScannerSettings? = null) =
        coroutineScope {
            val settings = wifiScannerSettings
                ?: _settingService.getSettings(WifiScannerSettings::class.java)!!

            mutableStatePropertiesBySortMode.values
                .filter { it.value }
                .forEach { it.value = false }

            val sortModeMutableField = mutableStatePropertiesBySortMode[settings.sortMode]!!
            sortModeMutableField.value = true

            mutableStatePropertiesByWifiFilter.values
                .filter { it.value }
                .forEach { it.value = false }

            settings.filters.forEach { filter ->
                val filterMutableField = mutableStatePropertiesByWifiFilter[filter]!!
                filterMutableField.value = true
            }
        }

    suspend fun saveSettings() = coroutineScope {
        val wifiScannerSettings = _settingService
            .getSettings(WifiScannerSettings::class.java)!!

        val newFilters = mutableStatePropertiesByWifiFilter
            .filter { it.value.value }
            .map { it.key }

        wifiScannerSettings.filters = newFilters
        wifiScannerSettings.sortMode = mutableStatePropertiesBySortMode
            .toList()
            .first { it.second.value }
            .first

        _settingService.updateSettings(wifiScannerSettings)
    }

    suspend fun resetSettings() = coroutineScope {
        val defaultSettings =
            _initSettingsService.initDefaultWifiScannerSettings(updateIfExist = true)
        synchronizeStateBySettings(defaultSettings)

    }
}