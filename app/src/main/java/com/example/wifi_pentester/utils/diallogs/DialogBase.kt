package com.example.wifi_pentester.utils.diallogs

import android.app.Dialog
import android.content.DialogInterface
import android.view.View
import androidx.fragment.app.DialogFragment
import androidx.fragment.app.FragmentManager
import com.example.wifi_pentester.R
import com.google.android.material.dialog.MaterialAlertDialogBuilder
import kotlinx.coroutines.CancellableContinuation
import kotlinx.coroutines.suspendCancellableCoroutine

abstract class DialogBase : DialogFragment() {
    protected abstract val dialogTag: String
    private var cancellableContinuation: CancellableContinuation<Unit>? = null

    protected fun onCreateDialog(rootView: View): Dialog {
        return MaterialAlertDialogBuilder(requireContext(), R.style.MaterialAlertDialog_Material3)
            .setView(rootView)
            .create()
    }

    suspend fun showAsync(manager: FragmentManager) =
        suspendCancellableCoroutine { x ->
            cancellableContinuation = x
            super.show(manager, dialogTag)

            x.invokeOnCancellation {
                super.dismiss()
            }
        }

    override fun onDismiss(dialog: DialogInterface) {
        super.onDismiss(dialog)
        cancellableContinuation?.cancel()
        cancellableContinuation = null
    }

    override fun onCancel(dialog: DialogInterface) {
        super.onCancel(dialog)
        cancellableContinuation?.cancel()
        cancellableContinuation = null
    }
}